<!doctype html>
<html>
  <head>
    <title>Ember Court Planner</title>
    <style>
      html {
          font-family: sans-serif;
          background: #282828;
          color: #ddd;
      }
      summary {
          font-weight: bold;
      }
      img.icon {
          vertical-align: middle;
      }
      #matrix {
          border-collapse: collapse;
      }
      #matrix td, #matrix th {
          border: solid 1px #888;
          padding: 4px;
      }
      #matrix th {
          background: #111;
      }
      #preference .status-level {
          padding: 4px;
      }
      #preference .status-level.missing {
          background: #f00;
          color: #000;
      }
      #preference .status-level.used {
          background: #0f0;
          color: #000;
      }
      #preference .status-level.used.excess {
          background: #0ff;
          color: #000;
      }
      #guests .level.unused {
          color: #0f0;
      }
      #guests .level.used {
          color: #0f0;
      }
      #guests .level.used.excess {
          color: #0ff;
      }
      #guests .level.missing {
          color: #f00;
      }
      #amenities .level.missing {
          color: #ff0;
      }
      #amenities .level.used {
          color: #0f0;
      }
      #amenities .level.used.excess {
          color: #0ff;
      }
    </style>
  </head>
  <body>
    <table id="matrix"></table>
   <!--
      <tr>
        <th>Slot</th>
        <th><input type="checkbox"></th>
        <th>Option</th>
        <th><a href="https://www.wowhead.com/spell=331380"><img class="icon" src="https://wow.zamimg.com/images/wow/icons/tiny/inv_pet_broom.gif" alt="Cleanliness Level"></a></th>
        <th><a href="https://www.wowhead.com/spell=331382"><img class="icon" src="https://wow.zamimg.com/images/wow/icons/tiny/achievement_legionpvptier3.gif" alt="Danger Level"></a></th>
      </tr>
      <tr>
        <td>Guest 1</td>
        <td><input type="checkbox" id="sika"></td>
        <td><label for="sika"><div>Sika</div></label></td>
        <td>+1</td>
        <td></td>
      </tr>
      <tr>
        <td>Guest 1</td>
        <td><input type="checkbox" id="marileth"></td>
        <td><label for="marileth">Plague Deviser Marileth</label></td>
        <td>-1</td>
        <td></td>
      </tr>
    </table> -->
    <details>
      <summary>Help</summary>
      Red = Unsatisfied need. Green = Satisfied. Cyan = Satisfied multiple times.
    </details>
    <fieldset id="guests">
      <legend>Guests</legend>
    </fieldset>
    <table id="preference">
      <tr id="preference-0"></tr>
      <tr id="preference-1"></tr>
    </table>
    <fieldset id="amenities">
      <legend>Amenities</legend>
    </fieldset>
    <script>
      const ATTRIBUTES = [
          {
              id: 331380,
              name: "Cleanliness",
              levels: [
                  {name: "Messy", icon: "ability_creature_poison_06"},
                  {name: "Clean", icon: "inv_pet_broom"},
              ]
          },
          {
              id: 331382,
              name: "Danger",
              levels: [
                  {name: "Safe", icon: "ability_priest_angelicbulwark"},
                  {name: "Dangerous", icon: "achievement_legionpvptier3"},
              ],
          },
          {
              id: 331383,
              name: "Decadence",
              levels: [
                  {name: "Humble", icon: "inv_crate_07"},
                  {name: "Decadent", icon: "inv_misc_food_145_cake"},
              ],
          },
          {
              id: 331384,
              name: "Excitement",
              levels: [
                  {name: "Relaxing", icon: "spell_nature_healingtouch"},
                  {name: "Exciting", icon: "inv_misc_missilelarge_purple"},
              ],
          },
          {
              id: 331385,
              name: "Formality",
              levels: [
                  {name: "Casual", icon: "inv_shirt_12"},
                  {name: "Formal", icon: "inv_shirt_white_01"},
              ],
          },
      ];

      const SLOTS = [
          {
              guests: [
                  {name: "Sika", preferences: {0: 1}},
                  {name: "Plague Deviser Marileth", preferences: {0: 0}},
                  {name: "Choofa", preferences: {3: 1}},
                  {name: "Cryptkeeper Kassir", preferences: {4: 1}}
              ],
          },
          {
              guests: [
                  {name: "Kleia and Pelagos", preferences: {2: 0}},
                  {name: "Grandmaster Vole", preferences: {1: 1}},
                  {name: "Droman Aliothe", preferences: {3: 0}},
                  {name: "Stonehead", preferences: {4: 0}}
              ],
          },
          {
              guests: [
                  {name: "Polemarch Adrestes", preferences: {0: 1, 4: 1}},
                  {name: "Alexandros Mograine", preferences: {1: 0, 2: 0}},
                  {name: "Hunt-Captain Korayn", preferences: {1: 1, 4: 0}},
                  {name: "Rendle and Cudgelface", preferences: {0: 0, 3: 0}}
              ],
          },
          {
              guests: [
                  {name: "Mikanikos", preferences: {0: 1, 1: 0, 2: 0}},
                  {name: "Baroness Vashj", preferences: {1: 1, 2: 1, 3: 1}},
                  {name: "Lady Moonberry", preferences: {0: 0, 3: 1, 4: 0}},
                  {name: "The Countess", preferences: {2: 1, 3: 0, 4: 1}}
              ],
          }
      ];

      const BUILDINGS = [
          {
              name: "Entertainment",
              amenities: [
                  {name: "Atoning Rituals", features: {2: 0, 4: 1}},
                  {name: "Glimpse of the Wilds", features: {0: 1, 1: 0}},
                  {name: "Lost Chalice Band", features: {2: 1, 3: 1}}
              ]
          },
          {
              name: "Refreshment",
              amenities: [
                  {name: "Tubbin's Tea Party", features: {3: 0, 4: 1}},
                  {name: "Divine Desserts", features: {0: 0, 2: 1}},
                  {name: "Mushroom Surprise", features: {1: 1, 2: 0}}
              ]
          },
          {
              name: "Decorations",
              amenities: [
                  {name: "Traditional", features: {0: 1, 1: 1}},
                  {name: "Mortal Reminders", features: {3: 0, 4: 0}},
                  {name: "Mystery Mirrors", features: {1: 0, 3: 1}}
              ]
          },
          {
              name: "Security",
              amenities: [
                  {name: "Venthyr Volunteers", features: {1: 1, 3: 1}},
                  {name: "Stoneborn Reserves", features: {1: 0, 2: 1}},
                  {name: "Maldraxxian Army", features: {0: 0, 4: 0}}
              ]
          }
      ];

      function intersperse(separator, items) {
          return items.flatMap(item => [separator, item]).slice(1);
      }

      function modify(object, ...modifiers) {
          for (const modifier of modifiers) {
              modifier(object);
          }
          return object;
      }

      function makeElement(tagName, attributes, children) {
          const element = document.createElement(tagName)
          for (const [name, value] of Object.entries(attributes)) {
              const match = /^on(.*)$/.exec(name);
              if (match) {
                  element.addEventListener(match[1], value);
              } else {
                  element.setAttribute(name, value);
              }
          }
          for (const child of children) {
              element.append(child);
          }
          return element;
      }

      function identifier(name) {
          return name.toLowerCase().replace(/^[^a-z]|[^0-9a-z]/g, "_");
      }

      function renderIcon(icon) {
          return makeElement("img", {
              "class": "icon",
              "src": `https://wow.zamimg.com/images/wow/icons/tiny/${icon}.gif`,
          }, []);
      }

      function renderLevel(level) {
          return makeElement("span", {"class": `level level-${level.name}`}, [
              renderIcon(level.icon),
              " ",
              level.name,
          ]);
      }

      function onchange(e) {
          const element = e.target;
          localStorage.setItem(`fyl-ember-court-${element.id}`, element.checked);
          updateAll();
      }

      function updateAll() {
          const preferences = {};
          for (const slot of SLOTS) {
              for (const guest of slot.guests) {
                  const checkbox = document.querySelector(`#guest-${identifier(guest.name)} input[type=checkbox]`);
                  if (checkbox.checked) {
                      for (const [attribute, level] of Object.entries(guest.preferences)) {
                          const attrLevel = attribute * 2 + level;
                          preferences[attrLevel] = true;
                      }
                  }
              }
          }
          const features = {};
          for (const building of BUILDINGS) {
              for (const amenity of building.amenities) {
                  const checkbox = document.querySelector(`#amenity-${identifier(building.name)}-${identifier(amenity.name)} input[type=checkbox]`);
                  if (checkbox.checked) {
                      for (const [attribute, level] of Object.entries(amenity.features)) {
                          const attrLevel = attribute * 2 + level;
                          features[attrLevel] = (features[attrLevel] || 0) + 1;
                      }
                  }
              }
          }
          for (const [attrIndex, attribute] of ATTRIBUTES.entries()) {
              for (const [levelIndex, level] of attribute.levels.entries()) {
                  const attrLevel = attrIndex * 2 + levelIndex;
                  const feature = features[attrLevel] || 0;
                  const className = (() => {
                      if (preferences[attrLevel]) {
                          if (feature > 1) {
                              return "used excess";
                          } else if (feature > 0) {
                              return "used";
                          } else {
                              return "missing";
                          }
                      } else {
                          if (feature > 0) {
                              return "unused";
                          } else {
                              return "";
                          }
                      }
                  })()
                  document.querySelector(`#status-${level.name}`).
                      setAttribute("class", `status-level ${className}`);
                  for (const element of document.querySelectorAll(`#guests .level-${level.name}`)) {
                      element.setAttribute("class", `level level-${level.name} ${className}`);
                  }
                  for (const element of document.querySelectorAll(`#amenities .level-${level.name}`)) {
                      element.setAttribute("class", `level level-${level.name} ${className}`);
                  }
              }
          }
      }

      for (const row of [0, 1]) {
          document.getElementById(`preference-${row}`).replaceChildren(
              ...intersperse(" ", ATTRIBUTES.map(attribute =>
                  makeElement("td", {
                      "id": `status-${attribute.levels[row].name}`,
                      "class": "status-level",
                  }, [renderLevel(attribute.levels[row])])
              )),
          );
      }
      document.getElementById("guests").replaceChildren(
          ...SLOTS.map((slot, slotIndex) =>
              makeElement("fieldset", {}, [
                  makeElement("legend", {}, [`Slot ${slotIndex + 1}`]),
                  ...slot.guests.map(guest =>
                      makeElement("div", {
                          "id": `guest-${identifier(guest.name)}`,
                      }, [
                          makeElement("label", {}, [
                              makeElement("input", {
                                  "type": "checkbox",
                                  "id":  `guest-checkbox-${identifier(guest.name)}`,
                                  "onchange": onchange,
                              }, []),
                              guest.name,
                              ": ",
                              ...intersperse(" ", Object.entries(guest.preferences).map(([attribute, level]) =>
                                  renderLevel(ATTRIBUTES[attribute].levels[level])
                              )),
                          ]),
                      ])
                  ),
              ])
          )
      );

      document.getElementById("amenities").append(
          ...BUILDINGS.map(building =>
              makeElement("fieldset", {}, [
                  makeElement("legend", {}, [building.name]),
                  ...building.amenities.map(amenity =>
                      makeElement("div", {
                          "id": `amenity-${identifier(building.name)}-${identifier(amenity.name)}`,
                      }, [
                          makeElement("label", {}, [
                              makeElement("input", {
                                  "type": "checkbox",
                                  "id":  `amenity-checkbox-${identifier(building.name)}-${identifier(amenity.name)}`,
                                  "onchange": onchange,
                              }, []),
                              amenity.name,
                              ": ",
                              ...intersperse(" ", Object.entries(amenity.features).map(([attribute, level]) =>
                                  renderLevel(ATTRIBUTES[attribute].levels[level])
                              )),
                          ]),
                      ])
                  ),
              ])
          )
      );

      lstorageitems = [];
      for (const element of document.querySelectorAll("input[type=checkbox]")) {
          lstorageitems.push(`${element.id}`)
          element.checked = localStorage.getItem(`fyl-ember-court-${element.id}`) == "true";
      }

      updateAll();
    </script>
    <script>const whTooltips = {};</script>
    <script src="https://wow.zamimg.com/js/tooltips.js"></script>
  </body>
</html>
